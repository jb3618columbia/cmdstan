##
# LIBGTEST is the google test library
# GTEST_MAIN is the file that contains the google test
##
LIBGTEST = test/libgtest.a
GTEST_MAIN = $(GTEST)/src/gtest_main.cc
CFLAGS_GTEST += -I $(GTEST)/include -I $(GTEST)

##
# Build the google test library.
## 
$(LIBGTEST): $(LIBGTEST)(test/gtest.o)

test/gtest.o: $(GTEST)/src/gtest-all.cc
	@echo '--- compile $(LIBGTEST) ---'
	@mkdir -p test
	$(COMPILE.c) -O$O $(CFLAGS_GTEST) $< $(OUTPUT_OPTION)


##
# Rule for building a test
##
test/%.o : src/test/%_test.cpp $(LIBGTEST) bin/libstan.a
	@echo '-*- compile $@'
	@mkdir -p $(dir $@)
	$(COMPILE.c) -O$O $(CFLAGS_GTEST) $< $(OUTPUT_OPTION)

##
# Rule for building a test executable
##
test/%$(EXE) : test/%.o bin/libstan.a
	@echo '-*- link $@'
	@mkdir -p $(dir $@)
	$(LINK.c) -O$O $(GTEST_MAIN) $< $(CFLAGS_GTEST) $(OUTPUT_OPTION) $(LIBGTEST) $(LDLIBS)





############################################################
##
# Target to verify cmdstan header files
##
HEADER_TESTS := $(addsuffix -test,$(shell find src/cmdstan -name '*.hpp' -type f)) 

ifeq ($(OS_TYPE),win) 
  DEV_NULL = nul
else
  DEV_NULL = /dev/null
endif

.PHONY: HEADER_TESTS
%.hpp-test : %.hpp test/dummy.cpp
	$(COMPILE.c) -O0 -include $< -o $(DEV_NULL) test/dummy.cpp

test/dummy.cpp:
	@mkdir -p test
	@touch $@
	@echo "int main() {return 0;}" >> $@

.PHONY: test-headers
test-headers: $(HEADER_TESTS)


############################################################
##
# All interface tests depend on certain compiled models
##
test/interface/command.o : src/test/test-models/printer$(EXE) src/test/test-models/domain_fail$(EXE) src/test/test-models/proper$(EXE) src/test/test-models/value_fail$(EXE)
test/interface/csv_header_consistency.o: src/test/test-models/csv_header_consistency$(EXE)
test/interface/elapsed_time.o: src/test/test-models/test_model$(EXE)
test/interface/fixed_param_sampler.o: $(addsuffix $(EXE),$(addprefix src/test/test-models/, empty proper))
test/interface/gm/argument_configuration.o: src/test/test-models/test_model$(EXE)
test/interface/optimization_output.o: src/test/test-models/optimization_output$(EXE)
test/interface/print.o: src/test/interface/matrix_output.csv bin/print$(EXE)
test/interface/print_uninitialized.o: src/test/test-models/print_uninitialized$(EXE)
